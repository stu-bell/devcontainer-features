# Dev Container Features

Using https://github.com/devcontainers/feature-starter

# To add a feature

1. Add a folder in test for your feature
1. Start the devcontainer for the repo
1. Make sure the test works (fails!) with
1. Build out your feature until your tests pass
1. Use your feature locally in your .devcontainer projects
1. Or [disbribute it](./README-template.md#distributing-features)

# Dev iterations requiring feature reinstalls

To reinstall the feature after a code change (using devpod, podman, powershell)

```
devpod delete .; podman builder prune -a -f; devpod up . --reset
```

```
docker builder prune -a -f
```


# Tests

https://github.com/devcontainers/cli/blob/main/docs/features/test.md
https://containers.dev/guide/feature-authoring-best-practices

Command to quickly test feature with a particular image:
`devcontainer features test --skip-scenarios -f <FEATURE_NAME>  -i <IMAGE_URI>`
where <IMAGE_URI> could be, eg: mcr.microsoft.com/devcontainers/base:ubuntu 

To test all devcontainer.json configs in scenarios.json:

`devcontainer features test --skip-autogenerated`

## Duplicate tests

TODO

Tests what happens if a devcontainer.json installs the feature multiple times with different options. Feature installs should be idempotent.

# Issue running Docker-in-Docker tests...

oneliner:
```
export DOCKER_CONFIG=/tmp/docker-test-config && mkdir -p $DOCKER_CONFIG && echo '{"auths":{}}' > $DOCKER_CONFIG/config.json
```


## The Issue

When running `devcontainer features test` inside a DevPod workspace with Docker-in-Docker enabled, all Docker registry operations fail with:

```
ERROR: failed to solve: EOF
```

Or when trying to pull images:
```
Error retrieving credentials: Post "http://localhost:12049/docker-credentials": dial tcp 127.0.0.1:12049: connect: connection refused
docker: EOF
```

**Root cause:** DevPod sets `~/.docker/config.json` with `"credsStore": "devpod"`, which tells Docker to use a credential helper service on `localhost:12049`. This service exists on the host but not inside the DevPod container. The inner Docker daemon (from Docker-in-Docker) tries to use this credential helper and fails, blocking all registry access.

## How to Diagnose

**1. Check if Docker registry access fails:**
```bash
docker pull alpine
```

**2. Look for credential helper errors:**
```bash
docker run --rm alpine echo "test"
# Look for: "dial tcp 127.0.0.1:12049: connect: connection refused"
```

**3. Check your Docker config:**
```bash
cat ~/.docker/config.json
# Look for: "credsStore": "devpod"
```

If you see the credential helper error and `credsStore` is set to `devpod`, you have this issue.

## The Solution

Create a separate Docker config without the credential helper for the inner Docker daemon:

**Quick fix (current session only):**

```bash
# Create a clean Docker config for this session
# change docker config path from ~/.docker/ and create a new config.json
export DOCKER_CONFIG=/tmp/docker-test-config
mkdir -p $DOCKER_CONFIG
echo '{"auths":{}}' > $DOCKER_CONFIG/config.json

# Verify it works
docker pull alpine

# Run your test
devcontainer features test --skip-scenarios -f geminicli -i mcr.microsoft.com/devcontainers/base:ubuntu
```

**Permanent fix (persists across sessions):**

This allows DevPod to continue managing `~/.docker/config.json` on the host while the inner Docker daemon uses a separate config without the inaccessible credential helper.

# CI

TODO figure this out...
.github/workflows has yaml for 3 pipelines that may reference the starter template features (called color and hello)

# Docs generation

From the src directory (devcontainer cli command is available in the devcontainer for this project)
`devcontainer features generate-docs`

